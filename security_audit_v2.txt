SECURITY AUDIT V2 (HARDENING PATCH SET)
Project: TaskFlow (Django + Django Ninja + React/Vite)
Date: 2026-02-15
Scope: Address findings F-01, F-02, F-03, F-04, F-05, F-06, F-07, F-08, F-09, F-10, F-12, F-13, F-15, F-16, F-19, F-20.


1) Executive Summary
- This patch set hardens authentication, token handling, rate limiting, and production safety defaults without changing core product flows.
- The largest behavior changes are security-driven:
  - Large occurrence materialization ranges now hard-fail (422 range_too_large).
  - Telegram widget login now enforces auth_date freshness and replay protection.
  - Refresh-token reuse now triggers a session-wide revoke for the user.
- Residual CRITICAL risk remains until frontend token storage is migrated away from localStorage (F-07).

Production Readiness Verdict: NOT READY (until F-07 and edge hardening are completed)


2) Fixes Applied (Mapped to Finding IDs)

F-01 Repo hygiene & secrets
- Added gitignore rules to prevent committing:
  - backend SQLite artifacts (`backend/db.sqlite3`, `backend/*.sqlite3`)
  - dotenv files (`backend/.env`, `frontend/.env`, `frontend/.env.*`) with explicit allow for `*.env.example`
- Added "Secrets rotation required" notes:
  - README_BACKEND.md
  - README_DEPLOY.md

If these files were already tracked in git, you must remove them from the index (DO NOT run these automatically):
  - git rm --cached backend/db.sqlite3
  - git rm --cached frontend/.env
  - git rm --cached backend/.env
  - git commit -m "Stop tracking local secrets/artifacts"
Then rotate all secrets (DJANGO_SECRET_KEY, TELEGRAM_BOT_TOKEN, SENDGRID_API_KEY, DB passwords, etc).


F-02 Spoofable client IP trust (X-Forwarded-For)
- Implemented safe-by-default client IP extraction:
  - Only trusts X-Forwarded-For when REMOTE_ADDR is within TRUSTED_PROXY_NETS.
  - Default TRUSTED_PROXY_NETS empty => ignores XFF.
- Rewired rate limiting and auth meta logging to use this helper instead of directly reading HTTP_X_FORWARDED_FOR.


F-03 Occurrence materialization DoS
- Added MAX_TASK_RANGE_DAYS (default 31) and enforced strict 422 rejection for larger ranges:
  - /api/tasks (range queries via start/end)
  - /api/streak/summary
- Added second-line defense in the occurrence materializer engine so any caller cannot create large ranges by mistake.
- Adjusted streak current-streak computation to materialize in bounded windows (<= MAX_TASK_RANGE_DAYS) instead of one unbounded range.


F-04 Telegram widget replay protection
- Enforced auth_date freshness using TELEGRAM_AUTH_MAX_AGE_SECONDS (default 120s).
- Added replay protection using Redis:
  - tg_auth_seen:<hash> set NX with TTL=max age
  - replay => 401 code=telegram_auth_replay
  - Redis failure => 503 code=telegram_auth_unavailable (fail closed for authentication safety)


F-05 Password reset must revoke sessions
- After successful password reset:
  - Revokes all active refresh tokens for the user.
  - Invalidates other outstanding password reset tokens for that user.
- Response body is unchanged.


F-06 / F-15 One-time tokens in query string (Referer/history leakage)
- Moved one-time tokens to URL fragments:
  - Telegram magic: /auth/telegram#token=...
  - Password reset: /reset-password#token=...
- Frontend callback pages:
  - Read token from `location.hash` first, fallback to query param for backward compatibility.
  - Immediately scrub URL via history.replaceState after extracting token.
- Added Referrer-Policy protections:
  - frontend `index.html`: <meta name="referrer" content="no-referrer">
  - Django (DEBUG=False): SECURE_REFERRER_POLICY="no-referrer"


F-08 Refresh token reuse detection
- Refresh endpoint now treats presentation of a revoked/replaced refresh token as compromise:
  - Revokes all active refresh tokens for the user.
  - Returns 401 code=refresh_reuse.


F-09 CORS credentials safe defaults
- CORS_ALLOW_CREDENTIALS now defaults to False.
- Credentials can be enabled only via explicit env var: CORS_ALLOW_CREDENTIALS=true
- CSRF_TRUSTED_ORIGINS is now an independent env list (not derived from CORS).


F-10 Frontend dev-server exposure tightening
- Vite dev server now defaults to binding on 127.0.0.1 (not all interfaces).
- Vite allowedHosts no longer defaults to "all" unless explicitly enabled via VITE_ALLOWED_HOSTS="all".


F-12 / F-16 Production safety defaults & basic dev-compose tightening
- SECRET_KEY:
  - If DEBUG=False and DJANGO_SECRET_KEY is missing => startup error (ImproperlyConfigured).
- PUBLIC_APP_URL:
  - If DEBUG=False must be https://... else startup error.
- backend/docker-compose.yml:
  - Bound Postgres and backend ports to 127.0.0.1 to avoid LAN exposure by default (dev safety).


F-13 Identifier-based throttles
- Added per-identifier throttles (default 20/hour) alongside IP throttles:
  - /auth/login
  - /auth/forgot-password


F-19 Admin exposure hardening
- Added ADMIN_URL env var (default /admin/) and mounted Django admin at that path.
- Deployment docs recommend using a random admin path and edge rate limiting/IP allowlisting.


F-20 Cleanup command for expired tokens
- Added management command:
  - python manage.py cleanup_tokens --days 30
  - Deletes old used/expired password reset tokens, old used/expired telegram magic links, and old revoked refresh tokens.


3) New / Updated Environment Variables (Defaults)
- TRUSTED_PROXY_NETS=""
  - Comma-separated CIDRs. Empty => do not trust X-Forwarded-For.
- MAX_TASK_RANGE_DAYS=31
- TELEGRAM_AUTH_MAX_AGE_SECONDS=120
- AUTH_LOGIN_IDENTIFIER_RATE="20/h"
- AUTH_FORGOT_IDENTIFIER_RATE="20/h"
- CORS_ALLOW_CREDENTIALS=false (changed default)
- CSRF_TRUSTED_ORIGINS="http://localhost:8080,http://127.0.0.1:8080" (dev default; set explicitly in prod)
- ADMIN_URL="/admin/"

Production-only enforced requirements (when DJANGO_DEBUG=false):
- DJANGO_SECRET_KEY must be set (no silent generation)
- PUBLIC_APP_URL must start with https://


4) What Remains / Residual Risk

F-07 Token storage in localStorage (CRITICAL, not addressed by request)
- Current frontend stores JWT access/refresh in localStorage.
  - Any successful XSS results in account takeover and long-lived refresh theft.
- Recommended next hardening steps:
  - Migrate refresh token to HttpOnly Secure SameSite cookies (refresh not accessible to JS).
  - Add a strict CSP (at least: script-src 'self' + nonces; object-src 'none'; base-uri 'none').
  - Remove or heavily restrict any HTML injection paths; avoid future use of dangerouslySetInnerHTML.

Edge / infra hardening (partially out of repo scope)
- No production Nginx/TLS/security-headers config is defined in this repository.
- Recommended at edge:
  - TLS everywhere, HSTS, rate limits, request body limits, header normalization/sanitization.
  - Enforce Referrer-Policy and add security headers (CSP, X-Content-Type-Options, etc).
  - Ensure only trusted proxies can set forwarding headers; strip client-supplied XFF.


5) Production Exposure Verdict
NOT READY for hostile public-internet exposure until at minimum:
1) F-07 cookie-based session migration (or equivalent anti-XSS/token-theft hardening)
2) Verified edge proxy hardening (trusted proxies, TLS, security headers, rate limits)
