TaskFlow Security Audit Final
Date: 2026-02-16
Reviewer: Senior Application Security Engineer (code-level audit)

Executive Summary
Verdict: NOT READY

The project has materially improved security posture across backend and frontend, including cookie-based refresh handling, replay protection, trusted proxy IP extraction, range-DoS controls, CSP/security headers, and auth/session revocation logic. Regression checks passed for backend and frontend.

However, production readiness is blocked by repository hygiene risk: sensitive local artifacts are still tracked in git (`backend/db.sqlite3`, `frontend/.env`). If this repository has been shared, this creates immediate confidentiality and account-compromise risk and requires secret rotation and git history/index cleanup before public exposure.

Scope Checked
- Backend: Django/Ninja API, auth/session logic, rate limiting, token lifecycle, Telegram auth, password reset, tasks/streak materialization safeguards, settings, URL routing, management commands.
- Frontend: React/Vite auth flow, token storage behavior, refresh retry flow, token URL scrubbing, CSP compatibility, XSS-sensitive sinks, Vite dev host settings.
- Infra/deploy artifacts: docker-compose (dev), backend Dockerfile/entrypoint, added production Nginx baseline, env examples, readme operational controls.
- Security tests/smoke checks: Django tests and frontend vitest/type/build runs.

Findings Table (Prioritized)
ID | Severity | Status | Title | Location
TF-SEC-001 | CRITICAL | OPEN | Sensitive local artifacts tracked in git | repo index (`backend/db.sqlite3`, `frontend/.env`)
TF-SEC-002 | CRITICAL | FIXED | Client IP spoof via untrusted X-Forwarded-For | `backend/apps/common/ip.py:43`, `backend/apps/common/rate_limit.py:13`, `backend/apps/accounts/api.py:232`
TF-SEC-003 | CRITICAL | FIXED | Occurrence materialization DoS via oversized date ranges | `backend/apps/tasks/api.py:199`, `backend/apps/tasks/occurrences.py:112`, `backend/apps/streak/api.py:99`
TF-SEC-004 | CRITICAL | FIXED | Telegram widget replay/stale payload acceptance | `backend/apps/accounts/api.py:383`
TF-SEC-005 | CRITICAL | FIXED | Password reset did not revoke active sessions/tokens | `backend/apps/accounts/api.py:759`
TF-SEC-006 | CRITICAL | FIXED | One-time auth tokens leak via URL query/referrer | `backend/apps/accounts/password_reset.py:16`, `backend/apps/accounts/telegram_magic.py:72`, `frontend/src/pages/TelegramAuthCallback.tsx:18`, `frontend/src/pages/ResetPassword.tsx:26`
TF-SEC-007 | HIGH | FIXED | Refresh token JSON/body persistence path | `backend/apps/accounts/api.py:55`, `backend/config/settings.py:219`, `frontend/src/lib/apiClient.ts:73`, `frontend/src/lib/authSession.ts:5`
TF-SEC-008 | HIGH | FIXED | Missing strict CSP/security headers + frontend XSS sink hardening | `backend/apps/common/security_headers.py:23`, `backend/config/settings.py:160`, `frontend/src/components/ui/chart.tsx:68`, `frontend/index.html:6`
TF-SEC-009 | HIGH | FIXED | Unsafe CORS credentials default / CSRF origin coupling risk | `backend/config/settings.py:146`
TF-SEC-010 | MEDIUM | FIXED | Missing production fail-closed config guardrails | `backend/config/settings.py:27`, `backend/config/settings.py:203`, `backend/config/settings.py:228`
TF-SEC-011 | MEDIUM | FIXED | Admin/docs exposure hardening incomplete by default | `backend/config/urls.py:15`, `backend/config/settings.py:213`, `deploy/nginx/nginx.prod.conf:81`
TF-SEC-012 | LOW | FIXED | No lifecycle cleanup for stale auth artifacts | `backend/apps/accounts/management/commands/cleanup_tokens.py:12`, `README_DEPLOY.md:29`
TF-SEC-013 | MEDIUM | OPEN | Nginx admin rate-limit path may drift from randomized ADMIN_URL | `deploy/nginx/nginx.prod.conf:81`, `backend/config/settings.py:213`

Detailed Findings

TF-SEC-001 (CRITICAL, OPEN)
Title: Sensitive local artifacts tracked in git
Location:
- tracked file: `backend/db.sqlite3`
- tracked file: `frontend/.env`
Impact:
- Potential secret disclosure, user data leakage, and offline attack surface if repository is shared.
Exploitability: High (repository access is sufficient).
Remediation Plan:
1) Untrack files from git index.
2) Rotate all potentially exposed secrets.
3) Keep ignore rules in place.
Applied Fixes:
- `.gitignore` now ignores `backend/db.sqlite3`, `backend/*.sqlite3`, `backend/.env`, `frontend/.env`, while allowing `*.env.example`.
Required Git Commands (not executed by audit):
- `git rm --cached backend/db.sqlite3`
- `git rm --cached frontend/.env`
- `git commit -m "chore(security): stop tracking local secrets/artifacts"`
Required Secret Rotation:
- `DJANGO_SECRET_KEY`, `SENDGRID_API_KEY`, `TELEGRAM_BOT_TOKEN`, DB credentials, any tokens derived under previous key material.

TF-SEC-002 (CRITICAL, FIXED)
Title: Client IP spoof via untrusted forwarding headers
Location:
- `backend/apps/common/ip.py:43`
- `backend/apps/common/rate_limit.py:13`
- `backend/apps/accounts/api.py:232`
Impact:
- Rate-limit bypass and misleading audit logs.
Exploitability: High.
Fix:
- Added trusted-proxy CIDR parsing (`TRUSTED_PROXY_NETS`) and safe default (ignore XFF if proxy not trusted).
- Replaced direct metadata access with `request_ip(request)` in rate limiting/auth metadata paths.

TF-SEC-003 (CRITICAL, FIXED)
Title: Occurrence materialization DoS via oversized ranges
Location:
- `backend/apps/tasks/api.py:199`
- `backend/apps/tasks/occurrences.py:112`
- `backend/apps/streak/api.py:99`
Impact:
- CPU/DB amplification from oversized date windows.
Exploitability: High.
Fix:
- Added `MAX_TASK_RANGE_DAYS` cap enforcement at endpoint boundary and inside materialization engine as second-line defense.
- Returns structured 422 with `code=range_too_large`.

TF-SEC-004 (CRITICAL, FIXED)
Title: Telegram widget replay/stale payload acceptance
Location:
- `backend/apps/accounts/api.py:383`
Impact:
- Replay can re-authenticate users within stale window.
Exploitability: Medium-High.
Fix:
- Enforced `auth_date` max age (`TELEGRAM_AUTH_MAX_AGE_SECONDS`).
- Added Redis replay key (`tg_auth_seen:<hash>`) with TTL and fail-closed behavior.

TF-SEC-005 (CRITICAL, FIXED)
Title: Password reset did not revoke active sessions/tokens
Location:
- `backend/apps/accounts/api.py:759`
Impact:
- Account recovery would not evict attacker sessions.
Exploitability: High after account compromise.
Fix:
- On successful reset: revoke all active refresh sessions for user and mark other reset tokens used.
- Clear auth cookies in response.

TF-SEC-006 (CRITICAL, FIXED)
Title: One-time token leakage via query and referrer
Location:
- `backend/apps/accounts/password_reset.py:16`
- `backend/apps/accounts/telegram_magic.py:72`
- `frontend/src/pages/TelegramAuthCallback.tsx:18`
- `frontend/src/pages/ResetPassword.tsx:26`
- `frontend/index.html:6`
- `backend/config/settings.py:172`
Impact:
- Token leakage through browser history, logs, Referer headers.
Exploitability: High.
Fix:
- Moved reset/magic tokens to URL fragment.
- Added hash+query backward-compatible parser on frontend, immediate `history.replaceState` scrub.
- Added referrer policy at frontend meta and backend secure referrer policy in production.

TF-SEC-007 (HIGH, FIXED)
Title: Refresh token persistence risk in JS-accessible channels
Location:
- `backend/apps/accounts/api.py:55`
- `backend/config/settings.py:219`
- `frontend/src/lib/authSession.ts:5`
- `frontend/src/lib/apiClient.ts:73`
- `frontend/src/lib/authStorage.ts` (deleted)
Impact:
- Token exfiltration risk from XSS/local compromise.
Exploitability: High.
Fix:
- Refresh token constrained to HttpOnly/Secure/SameSite cookie path `/api/auth/refresh`.
- Frontend now memory-only auth session; no auth token persistence in localStorage/sessionStorage.
- API client uses `credentials: include`, refresh-on-401 with single retry.

TF-SEC-008 (HIGH, FIXED)
Title: Missing strict CSP/security headers + XSS sink hardening
Location:
- `backend/apps/common/security_headers.py:23`
- `backend/config/settings.py:160`
- `deploy/nginx/nginx.prod.conf:54`
- `frontend/src/components/ui/chart.tsx:68`
Impact:
- Higher blast radius from script/style injection and content-type confusion.
Exploitability: Medium-High.
Fix:
- Added production CSP middleware with nonce support and strict directives.
- Enabled nosniff, frame deny, HSTS controls in settings; edge config includes hardened headers.
- Sanitized dynamic tokens/colors before chart style injection.

TF-SEC-009 (HIGH, FIXED)
Title: CORS credentials unsafe default / CSRF origin coupling
Location:
- `backend/config/settings.py:146`
Impact:
- Risk of over-broad browser trust if credentials are enabled by default.
Exploitability: Medium.
Fix:
- `CORS_ALLOW_CREDENTIALS` default false; CSRF trusted origins configured independently.

TF-SEC-010 (MEDIUM, FIXED)
Title: Missing production fail-closed config controls
Location:
- `backend/config/settings.py:27`
- `backend/config/settings.py:203`
- `backend/config/settings.py:228`
Impact:
- Unsafe startup with missing/weak deployment configuration.
Exploitability: Medium.
Fix:
- Production now fails startup when:
  - `DJANGO_SECRET_KEY` missing,
  - `PUBLIC_APP_URL` is not https,
  - `AUTH_COOKIE_SECURE` is false,
  - refresh-in-body is enabled.

TF-SEC-011 (MEDIUM, FIXED)
Title: Admin/docs exposure hardening
Location:
- `backend/config/settings.py:213`
- `backend/config/urls.py:15`
- `README_DEPLOY.md:11`
Impact:
- Admin and API docs unnecessary exposure increases attack surface.
Exploitability: Medium.
Fix:
- Added configurable `ADMIN_URL` mount path.
- Restricted API docs/OpenAPI in production to authenticated staff.
- Added deploy notes and edge hardening baseline.

TF-SEC-012 (LOW, FIXED)
Title: No cleanup for stale auth artifacts
Location:
- `backend/apps/accounts/management/commands/cleanup_tokens.py:12`
- `README_DEPLOY.md:29`
Impact:
- Data retention bloat; stale auth artifacts remain longer than needed.
Exploitability: Low.
Fix:
- Added `cleanup_tokens` management command with age-based cleanup for reset/magic/revoked refresh records.

TF-SEC-013 (MEDIUM, OPEN)
Title: Nginx admin rate-limit path may drift from randomized ADMIN_URL
Location:
- `deploy/nginx/nginx.prod.conf:81`
- `backend/config/settings.py:213`
Impact:
- If admin path changes from `/admin/` and edge config is not updated, brute-force protections can be bypassed at edge location block.
Exploitability: Medium.
Remediation Plan:
- Parameterize Nginx admin location during deployment (envsubst/template) to match `ADMIN_URL`, or duplicate rate limiting at upstream WAF/API gateway level.

Fixes Applied Mapping (Finding -> Change Summary)
- TF-SEC-002 -> Added trusted proxy parser and centralized safe IP extraction; replaced direct XFF usage in rate-limit/auth metadata.
- TF-SEC-003 -> Added strict endpoint range caps and materializer second-line cap (`MAX_TASK_RANGE_DAYS`).
- TF-SEC-004 -> Added Telegram auth freshness validation + Redis replay lock key.
- TF-SEC-005 -> Password reset now revokes all refresh sessions and invalidates other reset tokens.
- TF-SEC-006 -> Moved one-time tokens to URL fragment; frontend token scrub + no-referrer policies.
- TF-SEC-007 -> Cookie-only refresh architecture, memory-only access token state, removed legacy persisted auth storage.
- TF-SEC-008 -> Added strict CSP middleware/security headers and frontend chart style sanitization.
- TF-SEC-009 -> CORS credential default hardened; CSRF trust list separated.
- TF-SEC-010 -> Production startup guardrails for secret key, HTTPS app URL, secure auth-cookie settings.
- TF-SEC-011 -> Admin URL configurability and production docs restriction to staff.
- TF-SEC-012 -> Added scheduled-cleanup command and deployment doc guidance.
- TF-SEC-001 -> Partial (ignore rules/docs) complete; tracked files still require git index cleanup and credential rotation.

Regression / Smoke Tests Added
Backend tests:
- `backend/apps/accounts/tests_security.py`
- `backend/apps/common/tests_security.py`

Frontend checks:
- `frontend/src/lib/passwordStrength.test.ts`

Executed Verification
- `cd backend; .\.venv\Scripts\python.exe manage.py check` -> PASS
- `cd backend; .\.venv\Scripts\python.exe manage.py test apps.accounts.tests_security apps.common.tests_security` -> PASS (7 tests)
- `cd frontend; npx tsc --noEmit` -> PASS
- `cd frontend; npm run test` -> PASS (3 tests)
- `cd frontend; npm run build` -> PASS

Residual Risks and Next Steps
1) CRITICAL: Untrack `backend/db.sqlite3` and `frontend/.env` from git index and rotate all secrets immediately.
2) Ensure deployment actually uses hardened edge config (`deploy/nginx/nginx.prod.conf`) and that admin location block matches `ADMIN_URL`.
3) Consider adding CI gates for security checks/tests so regressions fail pull requests.
4) Consider stronger CSP tightening for `style-src` and `connect-src` when operationally feasible.

Manual Verification Checklist
- Auth/session:
  - Login/register/telegram magic succeed; refresh cookie is HttpOnly/Secure/SameSite and scoped to `/api/auth/refresh`.
  - No JWT appears in localStorage/sessionStorage.
  - On browser reload, session restores via refresh+me without persisted JS token.
  - 401 from protected API triggers single refresh + retry.
  - Logout clears cookies and protected routes.
- Password reset:
  - Reset link uses `#token=` fragment.
  - URL token is scrubbed from bar immediately after page loads.
  - Successful reset revokes prior sessions.
- Telegram auth:
  - Stale `auth_date` rejected.
  - Replay of same widget payload rejected with `telegram_auth_replay`.
- Rate limits/proxy trust:
  - With empty `TRUSTED_PROXY_NETS`, spoofed XFF does not alter effective client IP.
  - Oversized task/streak date ranges return 422 `range_too_large`.
- Headers/CSP:
  - Production responses include CSP/HSTS/nosniff/frame-deny/referrer policy headers.
  - Admin/docs exposure follows staff-only and edge restrictions.

Production Readiness Verdict
NOT READY

Blocking conditions:
- TF-SEC-001 unresolved (tracked sensitive artifacts + required credential rotation not yet completed).
